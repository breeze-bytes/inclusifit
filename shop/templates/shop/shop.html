{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InclusiFit Shop</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/shop.css' %}">
</head>
<body>
  <!-- Navbar -->
  <header>
    <nav>
      <a href="{% url 'home' %}" class="logo">InclusiFit</a>
      <ul>
        <li><a href="{% url 'home' %}">Home</a></li>
        <li><a href="{% url 'shop:shop' %}">Shop</a></li>
        <li><a href="#">Contact</a></li>
        <li><a href="{% url 'shop:cart' %}" id="cart-link">ðŸ›’ Cart ({{ cart_item_count }})</a></li>
      </ul>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <h1>InclusiFit Shop</h1>
    <p>Inclusive Fitness Gear â€“ Designed for Everyone</p>
  </section>

  <!-- Features Section -->
  <section class="features">
    <h2>Why Choose InclusiFit?</h2>
    <ul>
      <li>âœ… Available in multiple sizes to fit every body type</li>
      <li>âœ… Durable, comfortable, and high-quality fabric</li>
      <li>âœ… Perfect for sports, training, and everyday use</li>
    </ul>
  </section>

  <!-- Product Listing -->
  <main class="shop-container">
    {% if products %}
      <div class="product-grid">
        {% for product in products %}
          <div class="product-card">
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
            <h3>{{ product.name }}</h3>
            <p class="price">KSh {{ product.price }}</p>

            <!-- Add-to-Cart AJAX Form -->
            <form class="add-to-cart-ajax" data-product-id="{{ product.id }}">
              {% csrf_token %}
              <label for="size_{{ product.id }}">Size:</label>
              <select name="size" id="size_{{ product.id }}" required>
                {% for size in product.sizes.all %}
                  <option value="{{ size.id }}">{{ size.size }} ({{ size.stock }} available)</option>
                {% endfor %}
              </select>

              <label for="quantity_{{ product.id }}">Quantity:</label>
              <input type="number" name="quantity" id="quantity_{{ product.id }}" value="1" min="1">

              <button type="submit" class="btn-add">Add to Cart</button>
            </form>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>No products available at the moment.</p>
    {% endif %}
  </main>

  <!-- Popup Notification -->
  <div id="cart-popup">Added to Cart!</div>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 InclusiFit â€“ Inclusive Fitness Gear for Everyone</p>
  </footer>

  <!-- AJAX Script -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const forms = document.querySelectorAll(".add-to-cart-ajax");
      const popup = document.getElementById("cart-popup");
      const cartLink = document.getElementById("cart-link");

      forms.forEach(form => {
        form.addEventListener("submit", e => {
          e.preventDefault();
          const productId = form.dataset.productId;
          const size = form.querySelector("select[name='size']").value;
          const quantity = form.querySelector("input[name='quantity']").value;
          const csrfToken = form.querySelector("[name=csrfmiddlewaretoken]").value;

          fetch(`/shop/add-to-cart/${productId}/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({ size, quantity })
          })
          .then(res => res.json())
          .then(data => {
            if(data.success){
              popup.textContent = `Added ${quantity} item(s) to Cart!`;
              popup.style.display = "block";
              setTimeout(() => popup.style.display = "none", 2000);

              // update navbar count
              if(cartLink && data.cart_item_count !== undefined){
                cartLink.textContent = `ðŸ›’ Cart (${data.cart_item_count})`;
              }
            }
          })
          .catch(err => console.error(err));
        });
      });
    });
  </script>
</body>
</html>
